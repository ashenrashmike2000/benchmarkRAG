name: BenchmarkRAG CI

on:
  push:
  pull_request:

jobs:
  docker-build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Get your repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Enable Docker build support
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Build your Docker image
      - name: Build Docker image
        run: |
          docker build -t benchmarkrag:test -f docker/Dockerfile .

      # 4. Run a small FAISS sanity test inside the container
      - name: Run FAISS sanity test
        run: |
          docker run --rm benchmarkrag:test python - << 'EOF'
          import numpy as np
          from src.vectorstore.faiss_store import FaissVectorStore

          store = FaissVectorStore(persist_dir="/tmp/faiss")
          vectors = np.random.rand(1000, 128).astype("float32")
          store.load_corpus_vectors(vectors)

          idx, latency = store.search(vectors[0], top_k=5)
          assert len(idx) == 5

          print("FAISS sanity test passed")
          EOF
